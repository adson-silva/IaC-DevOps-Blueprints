# ISO 27001

Este documento detalha como configurar a infraestrutura para atender aos requisitos de conformidade com a norma ISO 27001, focando em seguranÃ§a da informaÃ§Ã£o.

---

## Ãndice

1. [VisÃ£o Geral da ISO 27001](#visÃ£o-geral-da-iso-27001)
2. [Estrutura da Norma](#estrutura-da-norma)
3. [Controles do Anexo A](#controles-do-anexo-a)
4. [ImplementaÃ§Ã£o com IaC](#implementaÃ§Ã£o-com-iac)
5. [Controles de Rede](#controles-de-rede)
6. [Controles de Acesso](#controles-de-acesso)
7. [Criptografia](#criptografia)
8. [Logging e Monitoramento](#logging-e-monitoramento)
9. [Backup e RecuperaÃ§Ã£o](#backup-e-recuperaÃ§Ã£o)
10. [Checklist de Conformidade](#checklist-de-conformidade)

---

## VisÃ£o Geral da ISO 27001

### O que Ã© ISO 27001?

A **ISO/IEC 27001** Ã© uma norma internacional que especifica requisitos para estabelecer, implementar, manter e melhorar continuamente um **Sistema de GestÃ£o de SeguranÃ§a da InformaÃ§Ã£o (SGSI)**.

### BenefÃ­cios

| BenefÃ­cio | DescriÃ§Ã£o |
|-----------|-----------|
| **ProteÃ§Ã£o de Dados** | Protege informaÃ§Ãµes confidenciais contra ameaÃ§as |
| **ConfianÃ§a** | Demonstra compromisso com seguranÃ§a para clientes |
| **Compliance** | Facilita conformidade com regulamentaÃ§Ãµes (LGPD, GDPR) |
| **Vantagem Competitiva** | Diferencial de mercado |
| **ReduÃ§Ã£o de Riscos** | Identifica e mitiga riscos de seguranÃ§a |
| **Melhoria ContÃ­nua** | Processos de auditoria e melhoria |

### Ciclo PDCA

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Ciclo PDCA do SGSI                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚        â”‚   PLAN   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚    DO    â”‚           â”‚
â”‚        â”‚          â”‚                 â”‚          â”‚           â”‚
â”‚        â”‚ Estabele-â”‚                 â”‚ Implemen-â”‚           â”‚
â”‚        â”‚ cer SGSI â”‚                 â”‚ tar SGSI â”‚           â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚             â–²                             â”‚                 â”‚
â”‚             â”‚                             â–¼                 â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚        â”‚   ACT    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  CHECK   â”‚           â”‚
â”‚        â”‚          â”‚                 â”‚          â”‚           â”‚
â”‚        â”‚ Manter e â”‚                 â”‚ Monitorarâ”‚           â”‚
â”‚        â”‚ Melhorar â”‚                 â”‚ e Revisarâ”‚           â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Estrutura da Norma

### ClÃ¡usulas Principais (4-10)

| ClÃ¡usula | TÃ­tulo | DescriÃ§Ã£o |
|----------|--------|-----------|
| **4** | Contexto da OrganizaÃ§Ã£o | Entender a organizaÃ§Ã£o e seu contexto |
| **5** | LideranÃ§a | Comprometimento da alta direÃ§Ã£o |
| **6** | Planejamento | AÃ§Ãµes para abordar riscos e oportunidades |
| **7** | Apoio | Recursos, competÃªncia, conscientizaÃ§Ã£o |
| **8** | OperaÃ§Ã£o | Planejamento e controle operacional |
| **9** | AvaliaÃ§Ã£o de Desempenho | Monitoramento, mediÃ§Ã£o, anÃ¡lise |
| **10** | Melhoria | NÃ£o conformidades e aÃ§Ãµes corretivas |

### Anexo A - Controles

O Anexo A contÃ©m **93 controles** organizados em **4 temas**:

| Tema | Controles | Exemplos |
|------|-----------|----------|
| **Organizacionais** | 37 | PolÃ­ticas, papÃ©is, inventÃ¡rio |
| **Pessoais** | 8 | SeleÃ§Ã£o, treinamento, desligamento |
| **FÃ­sicos** | 14 | PerÃ­metros, equipamentos, mÃ­dia |
| **TecnolÃ³gicos** | 34 | AutenticaÃ§Ã£o, criptografia, logs |

---

## Controles do Anexo A

### Controles TecnolÃ³gicos Relevantes para IaC

| ID | Controle | ImplementaÃ§Ã£o IaC |
|----|----------|-------------------|
| **A.5.15** | Controle de acesso | IAM policies, RBAC |
| **A.5.16** | Gerenciamento de identidade | Identity providers, MFA |
| **A.5.17** | InformaÃ§Ãµes de autenticaÃ§Ã£o | Secrets management |
| **A.5.23** | SeguranÃ§a em nuvem | Security groups, WAF |
| **A.8.9** | Gerenciamento de configuraÃ§Ã£o | IaC, Config as Code |
| **A.8.10** | ExclusÃ£o de informaÃ§Ãµes | Data lifecycle policies |
| **A.8.11** | Mascaramento de dados | Encryption, tokenization |
| **A.8.12** | PrevenÃ§Ã£o de vazamento | DLP policies |
| **A.8.13** | Backup | Backup policies, replication |
| **A.8.15** | Logging | CloudTrail, Log Analytics |
| **A.8.16** | Atividades de monitoramento | SIEM, alertas |
| **A.8.20** | SeguranÃ§a de redes | VPC, NSG, firewalls |
| **A.8.21** | ServiÃ§os de rede seguros | TLS, endpoints privados |
| **A.8.22** | SegregaÃ§Ã£o de redes | Subnets, VLANs |
| **A.8.24** | Uso de criptografia | Encryption at rest/transit |

---

## ImplementaÃ§Ã£o com IaC

### PolÃ­tica de SeguranÃ§a como CÃ³digo

```hcl
# Sentinel Policy (Terraform Enterprise)
# Garantir criptografia em S3

import "tfplan/v2" as tfplan

s3_buckets = filter tfplan.resource_changes as _, rc {
  rc.type is "aws_s3_bucket" and
  rc.mode is "managed" and
  (rc.change.actions contains "create" or rc.change.actions contains "update")
}

require_encryption = rule {
  all s3_buckets as _, bucket {
    bucket.change.after.server_side_encryption_configuration is not null
  }
}

main = rule {
  require_encryption
}
```

```rego
# OPA Policy
# Garantir que VMs tÃªm discos criptografados

package terraform.aws

deny[msg] {
  resource := input.resource_changes[_]
  resource.type == "aws_instance"
  not resource.change.after.root_block_device[_].encrypted
  msg := sprintf("Instance %s must have encrypted root volume", [resource.address])
}

deny[msg] {
  resource := input.resource_changes[_]
  resource.type == "aws_instance"
  ebs := resource.change.after.ebs_block_device[_]
  not ebs.encrypted
  msg := sprintf("Instance %s must have all EBS volumes encrypted", [resource.address])
}
```

---

## Controles de Rede

### A.8.20 - SeguranÃ§a de Redes

#### AWS - VPC e Security Groups

```hcl
# VPC com flow logs
resource "aws_vpc" "main" {
  cidr_block           = "10.0.0.0/16"
  enable_dns_hostnames = true
  enable_dns_support   = true
  
  tags = {
    Name        = "secure-vpc"
    Compliance  = "ISO27001"
    Control     = "A.8.20"
  }
}

# Flow Logs para auditoria
resource "aws_flow_log" "main" {
  vpc_id                   = aws_vpc.main.id
  traffic_type             = "ALL"
  log_destination_type     = "cloud-watch-logs"
  log_destination          = aws_cloudwatch_log_group.flow_logs.arn
  iam_role_arn             = aws_iam_role.flow_logs.arn
  max_aggregation_interval = 60
  
  tags = {
    Compliance = "ISO27001"
    Control    = "A.8.15"
  }
}

# Security Group restritivo
resource "aws_security_group" "web" {
  name        = "web-sg"
  description = "Security group for web tier - ISO27001 compliant"
  vpc_id      = aws_vpc.main.id
  
  # Ingress rules - apenas portas necessÃ¡rias
  ingress {
    description = "HTTPS from load balancer"
    from_port   = 443
    to_port     = 443
    protocol    = "tcp"
    security_groups = [aws_security_group.alb.id]
  }
  
  # Egress rules - restritivo
  egress {
    description = "HTTPS to internet"
    from_port   = 443
    to_port     = 443
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }
  
  egress {
    description = "Database access"
    from_port   = 5432
    to_port     = 5432
    protocol    = "tcp"
    security_groups = [aws_security_group.db.id]
  }
  
  tags = {
    Compliance = "ISO27001"
    Control    = "A.8.20"
  }
}
```

### A.8.22 - SegregaÃ§Ã£o de Redes

```hcl
# Subnets segregadas por funÃ§Ã£o
locals {
  subnets = {
    web = {
      cidr = "10.0.1.0/24"
      tier = "public"
    }
    app = {
      cidr = "10.0.2.0/24"
      tier = "private"
    }
    db = {
      cidr = "10.0.3.0/24"
      tier = "data"
    }
    mgmt = {
      cidr = "10.0.100.0/24"
      tier = "management"
    }
  }
}

resource "aws_subnet" "subnets" {
  for_each = local.subnets
  
  vpc_id            = aws_vpc.main.id
  cidr_block        = each.value.cidr
  availability_zone = var.availability_zone
  
  tags = {
    Name       = "subnet-${each.key}"
    Tier       = each.value.tier
    Compliance = "ISO27001"
    Control    = "A.8.22"
  }
}

# Network ACLs para segregaÃ§Ã£o adicional
resource "aws_network_acl" "db" {
  vpc_id     = aws_vpc.main.id
  subnet_ids = [aws_subnet.subnets["db"].id]
  
  # Permitir apenas trÃ¡fego da subnet de aplicaÃ§Ã£o
  ingress {
    protocol   = "tcp"
    rule_no    = 100
    action     = "allow"
    cidr_block = local.subnets.app.cidr
    from_port  = 5432
    to_port    = 5432
  }
  
  # Negar todo o resto
  ingress {
    protocol   = "-1"
    rule_no    = 200
    action     = "deny"
    cidr_block = "0.0.0.0/0"
    from_port  = 0
    to_port    = 0
  }
  
  egress {
    protocol   = "tcp"
    rule_no    = 100
    action     = "allow"
    cidr_block = local.subnets.app.cidr
    from_port  = 1024
    to_port    = 65535
  }
  
  tags = {
    Name       = "nacl-db"
    Compliance = "ISO27001"
    Control    = "A.8.22"
  }
}
```

---

## Controles de Acesso

### A.5.15 - Controle de Acesso

#### AWS IAM

```hcl
# PolÃ­tica de menor privilÃ©gio
data "aws_iam_policy_document" "app_policy" {
  statement {
    sid    = "AllowS3ReadOnly"
    effect = "Allow"
    
    actions = [
      "s3:GetObject",
      "s3:ListBucket"
    ]
    
    resources = [
      aws_s3_bucket.app_data.arn,
      "${aws_s3_bucket.app_data.arn}/*"
    ]
    
    condition {
      test     = "StringEquals"
      variable = "aws:RequestedRegion"
      values   = [var.region]
    }
  }
  
  statement {
    sid    = "AllowSecretsManager"
    effect = "Allow"
    
    actions = [
      "secretsmanager:GetSecretValue"
    ]
    
    resources = [
      "arn:aws:secretsmanager:${var.region}:${data.aws_caller_identity.current.account_id}:secret:app/*"
    ]
  }
}

resource "aws_iam_policy" "app" {
  name        = "app-policy"
  description = "Application policy - Least privilege - ISO27001 A.5.15"
  policy      = data.aws_iam_policy_document.app_policy.json
  
  tags = {
    Compliance = "ISO27001"
    Control    = "A.5.15"
  }
}

# Role com session duration limitada
resource "aws_iam_role" "app" {
  name               = "app-role"
  max_session_duration = 3600  # 1 hora
  
  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Action = "sts:AssumeRole"
        Effect = "Allow"
        Principal = {
          Service = "ec2.amazonaws.com"
        }
        Condition = {
          Bool = {
            "aws:MultiFactorAuthPresent" = "true"
          }
        }
      }
    ]
  })
  
  tags = {
    Compliance = "ISO27001"
    Control    = "A.5.15"
  }
}
```

### A.5.17 - InformaÃ§Ãµes de AutenticaÃ§Ã£o

```hcl
# AWS Secrets Manager
resource "aws_secretsmanager_secret" "db_password" {
  name        = "app/database/password"
  description = "Database password for application"
  
  recovery_window_in_days = 30
  
  tags = {
    Compliance = "ISO27001"
    Control    = "A.5.17"
  }
}

resource "aws_secretsmanager_secret_rotation" "db_password" {
  secret_id           = aws_secretsmanager_secret.db_password.id
  rotation_lambda_arn = aws_lambda_function.rotate_secret.arn
  
  rotation_rules {
    automatically_after_days = 30
  }
}

# Password Policy para IAM
resource "aws_iam_account_password_policy" "strict" {
  minimum_password_length        = 14
  require_lowercase_characters   = true
  require_numbers                = true
  require_uppercase_characters   = true
  require_symbols                = true
  allow_users_to_change_password = true
  max_password_age               = 90
  password_reuse_prevention      = 24
  hard_expiry                    = false
}
```

---

## Criptografia

### A.8.24 - Uso de Criptografia

#### Criptografia em Repouso

```hcl
# KMS Key com rotaÃ§Ã£o
resource "aws_kms_key" "main" {
  description             = "Main encryption key for ISO27001 compliance"
  deletion_window_in_days = 30
  enable_key_rotation     = true
  
  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Sid    = "Enable IAM User Permissions"
        Effect = "Allow"
        Principal = {
          AWS = "arn:aws:iam::${data.aws_caller_identity.current.account_id}:root"
        }
        Action   = "kms:*"
        Resource = "*"
      },
      {
        Sid    = "Allow Service Usage"
        Effect = "Allow"
        Principal = {
          Service = [
            "s3.amazonaws.com",
            "rds.amazonaws.com",
            "ebs.amazonaws.com"
          ]
        }
        Action = [
          "kms:Encrypt",
          "kms:Decrypt",
          "kms:GenerateDataKey*"
        ]
        Resource = "*"
      }
    ]
  })
  
  tags = {
    Compliance = "ISO27001"
    Control    = "A.8.24"
  }
}

# S3 com criptografia
resource "aws_s3_bucket_server_side_encryption_configuration" "data" {
  bucket = aws_s3_bucket.data.id
  
  rule {
    apply_server_side_encryption_by_default {
      kms_master_key_id = aws_kms_key.main.arn
      sse_algorithm     = "aws:kms"
    }
    bucket_key_enabled = true
  }
}

# RDS com criptografia
resource "aws_db_instance" "main" {
  identifier = "main-db"
  
  engine         = "postgres"
  engine_version = "15"
  instance_class = "db.t3.medium"
  
  allocated_storage     = 100
  max_allocated_storage = 1000
  storage_type          = "gp3"
  storage_encrypted     = true
  kms_key_id            = aws_kms_key.main.arn
  
  # ... outras configuraÃ§Ãµes
  
  tags = {
    Compliance = "ISO27001"
    Control    = "A.8.24"
  }
}

# EBS com criptografia padrÃ£o
resource "aws_ebs_encryption_by_default" "enabled" {
  enabled = true
}

resource "aws_ebs_default_kms_key" "main" {
  key_arn = aws_kms_key.main.arn
}
```

#### Criptografia em TrÃ¢nsito

```hcl
# ACM Certificate
resource "aws_acm_certificate" "main" {
  domain_name       = var.domain_name
  validation_method = "DNS"
  
  subject_alternative_names = [
    "*.${var.domain_name}"
  ]
  
  lifecycle {
    create_before_destroy = true
  }
  
  tags = {
    Compliance = "ISO27001"
    Control    = "A.8.24"
  }
}

# ALB com TLS 1.2+
resource "aws_lb_listener" "https" {
  load_balancer_arn = aws_lb.main.arn
  port              = 443
  protocol          = "HTTPS"
  ssl_policy        = "ELBSecurityPolicy-TLS13-1-2-2021-06"
  certificate_arn   = aws_acm_certificate.main.arn
  
  default_action {
    type             = "forward"
    target_group_arn = aws_lb_target_group.main.arn
  }
}

# S3 - ForÃ§ar HTTPS
resource "aws_s3_bucket_policy" "require_https" {
  bucket = aws_s3_bucket.data.id
  
  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Sid       = "DenyInsecureConnections"
        Effect    = "Deny"
        Principal = "*"
        Action    = "s3:*"
        Resource = [
          aws_s3_bucket.data.arn,
          "${aws_s3_bucket.data.arn}/*"
        ]
        Condition = {
          Bool = {
            "aws:SecureTransport" = "false"
          }
        }
      }
    ]
  })
}
```

---

## Logging e Monitoramento

### A.8.15 - Logging

```hcl
# CloudWatch Log Group com retenÃ§Ã£o
resource "aws_cloudwatch_log_group" "app" {
  name              = "/app/logs"
  retention_in_days = 365  # MÃ­nimo recomendado para auditoria
  kms_key_id        = aws_kms_key.logs.arn
  
  tags = {
    Compliance = "ISO27001"
    Control    = "A.8.15"
  }
}

# CloudTrail para auditoria
resource "aws_cloudtrail" "main" {
  name                          = "main-trail"
  s3_bucket_name                = aws_s3_bucket.cloudtrail.id
  include_global_service_events = true
  is_multi_region_trail         = true
  enable_log_file_validation    = true
  kms_key_id                    = aws_kms_key.cloudtrail.arn
  
  event_selector {
    read_write_type           = "All"
    include_management_events = true
    
    data_resource {
      type   = "AWS::S3::Object"
      values = ["arn:aws:s3:::"]
    }
  }
  
  insight_selector {
    insight_type = "ApiCallRateInsight"
  }
  
  insight_selector {
    insight_type = "ApiErrorRateInsight"
  }
  
  tags = {
    Compliance = "ISO27001"
    Control    = "A.8.15"
  }
}

# Config para conformidade
resource "aws_config_configuration_recorder" "main" {
  name     = "main-recorder"
  role_arn = aws_iam_role.config.arn
  
  recording_group {
    all_supported = true
  }
}

resource "aws_config_configuration_recorder_status" "main" {
  name       = aws_config_configuration_recorder.main.name
  is_enabled = true
  
  depends_on = [aws_config_delivery_channel.main]
}
```

### A.8.16 - Monitoramento

```hcl
# CloudWatch Alarms
resource "aws_cloudwatch_metric_alarm" "unauthorized_api_calls" {
  alarm_name          = "UnauthorizedAPICalls"
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = 1
  metric_name         = "UnauthorizedAttemptCount"
  namespace           = "CloudTrailMetrics"
  period              = 300
  statistic           = "Sum"
  threshold           = 1
  alarm_description   = "Alert on unauthorized API calls - ISO27001 A.8.16"
  
  alarm_actions = [aws_sns_topic.security_alerts.arn]
  
  tags = {
    Compliance = "ISO27001"
    Control    = "A.8.16"
  }
}

resource "aws_cloudwatch_metric_alarm" "root_account_usage" {
  alarm_name          = "RootAccountUsage"
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = 1
  metric_name         = "RootAccountUsage"
  namespace           = "CloudTrailMetrics"
  period              = 300
  statistic           = "Sum"
  threshold           = 0
  alarm_description   = "Alert on root account usage - ISO27001 A.8.16"
  
  alarm_actions = [aws_sns_topic.security_alerts.arn]
  
  tags = {
    Compliance = "ISO27001"
    Control    = "A.8.16"
  }
}

# GuardDuty
resource "aws_guardduty_detector" "main" {
  enable = true
  
  finding_publishing_frequency = "FIFTEEN_MINUTES"
  
  datasources {
    s3_logs {
      enable = true
    }
    kubernetes {
      audit_logs {
        enable = true
      }
    }
    malware_protection {
      scan_ec2_instance_with_findings {
        ebs_volumes {
          enable = true
        }
      }
    }
  }
  
  tags = {
    Compliance = "ISO27001"
    Control    = "A.8.16"
  }
}
```

---

## Backup e RecuperaÃ§Ã£o

### A.8.13 - Backup

```hcl
# AWS Backup Plan
resource "aws_backup_plan" "main" {
  name = "main-backup-plan"
  
  rule {
    rule_name         = "daily-backup"
    target_vault_name = aws_backup_vault.main.name
    schedule          = "cron(0 3 * * ? *)"  # 3 AM UTC diariamente
    
    lifecycle {
      delete_after = 30
    }
    
    copy_action {
      destination_vault_arn = aws_backup_vault.dr.arn
      
      lifecycle {
        delete_after = 90
      }
    }
  }
  
  rule {
    rule_name         = "weekly-backup"
    target_vault_name = aws_backup_vault.main.name
    schedule          = "cron(0 3 ? * SUN *)"  # Domingo 3 AM
    
    lifecycle {
      cold_storage_after = 30
      delete_after       = 365
    }
  }
  
  advanced_backup_setting {
    backup_options = {
      WindowsVSS = "enabled"
    }
    resource_type = "EC2"
  }
  
  tags = {
    Compliance = "ISO27001"
    Control    = "A.8.13"
  }
}

# Vault com criptografia
resource "aws_backup_vault" "main" {
  name        = "main-backup-vault"
  kms_key_arn = aws_kms_key.backup.arn
  
  tags = {
    Compliance = "ISO27001"
    Control    = "A.8.13"
  }
}

# Vault Lock para imutabilidade
resource "aws_backup_vault_lock_configuration" "main" {
  backup_vault_name   = aws_backup_vault.main.name
  min_retention_days  = 7
  max_retention_days  = 365
  changeable_for_days = 3
}

# Selection de recursos
resource "aws_backup_selection" "main" {
  name         = "main-backup-selection"
  plan_id      = aws_backup_plan.main.id
  iam_role_arn = aws_iam_role.backup.arn
  
  selection_tag {
    type  = "STRINGEQUALS"
    key   = "Backup"
    value = "true"
  }
  
  resources = [
    "arn:aws:rds:*:*:db:*",
    "arn:aws:ec2:*:*:volume/*"
  ]
}

# S3 ReplicaÃ§Ã£o
resource "aws_s3_bucket_replication_configuration" "main" {
  bucket = aws_s3_bucket.data.id
  role   = aws_iam_role.replication.arn
  
  rule {
    id     = "replicate-critical-data"
    status = "Enabled"
    
    filter {
      prefix = "critical/"
    }
    
    destination {
      bucket        = aws_s3_bucket.dr.arn
      storage_class = "STANDARD_IA"
      
      encryption_configuration {
        replica_kms_key_id = aws_kms_key.dr.arn
      }
    }
    
    delete_marker_replication {
      status = "Enabled"
    }
  }
}
```

---

## Checklist de Conformidade

### Checklist por Controle

#### Controles de Acesso (A.5.x)

- [ ] **A.5.15** - PolÃ­ticas IAM com menor privilÃ©gio
- [ ] **A.5.15** - RBAC implementado
- [ ] **A.5.16** - Identidades gerenciadas (no user credentials in code)
- [ ] **A.5.17** - Secrets em gerenciador de segredos
- [ ] **A.5.17** - RotaÃ§Ã£o automÃ¡tica de credenciais
- [ ] **A.5.18** - MFA habilitado para acesso privilegiado

#### Controles de Rede (A.8.20-22)

- [ ] **A.8.20** - VPC com flow logs habilitados
- [ ] **A.8.20** - Security groups restritivos
- [ ] **A.8.21** - TLS 1.2+ para todas as comunicaÃ§Ãµes
- [ ] **A.8.21** - Endpoints privados para serviÃ§os
- [ ] **A.8.22** - Subnets segregadas por funÃ§Ã£o
- [ ] **A.8.22** - NACLs configurados

#### Criptografia (A.8.24)

- [ ] Criptografia em repouso para todos os dados
- [ ] Criptografia em trÃ¢nsito (HTTPS/TLS)
- [ ] Chaves gerenciadas com KMS
- [ ] RotaÃ§Ã£o automÃ¡tica de chaves
- [ ] Certificados vÃ¡lidos e gerenciados

#### Logging (A.8.15-16)

- [ ] CloudTrail ativo em todas as regiÃµes
- [ ] Logs centralizados
- [ ] RetenÃ§Ã£o de logs conforme requisitos
- [ ] Logs protegidos contra alteraÃ§Ã£o
- [ ] Alertas de seguranÃ§a configurados
- [ ] SIEM/GuardDuty ativo

#### Backup (A.8.13)

- [ ] PolÃ­tica de backup definida
- [ ] Backups criptografados
- [ ] ReplicaÃ§Ã£o cross-region
- [ ] Testes de restauraÃ§Ã£o regulares
- [ ] Imutabilidade configurada

### EvidÃªncias para Auditoria

```bash
# Gerar relatÃ³rio de conformidade
aws configservice get-compliance-details-by-config-rule \
  --config-rule-name s3-bucket-server-side-encryption-enabled

# Listar recursos nÃ£o conformes
aws configservice get-compliance-summary-by-resource-type

# Exportar findings do Security Hub
aws securityhub get-findings \
  --filters '{"ComplianceStatus": [{"Value": "FAILED", "Comparison": "EQUALS"}]}'
```

### Terraform: Compliance Checks

```hcl
# AWS Config Rules para conformidade
resource "aws_config_config_rule" "s3_encryption" {
  name = "s3-bucket-server-side-encryption-enabled"
  
  source {
    owner             = "AWS"
    source_identifier = "S3_BUCKET_SERVER_SIDE_ENCRYPTION_ENABLED"
  }
  
  tags = {
    Compliance = "ISO27001"
    Control    = "A.8.24"
  }
}

resource "aws_config_config_rule" "iam_password_policy" {
  name = "iam-password-policy"
  
  source {
    owner             = "AWS"
    source_identifier = "IAM_PASSWORD_POLICY"
  }
  
  input_parameters = jsonencode({
    RequireUppercaseCharacters = "true"
    RequireLowercaseCharacters = "true"
    RequireSymbols             = "true"
    RequireNumbers             = "true"
    MinimumPasswordLength      = "14"
    PasswordReusePrevention    = "24"
    MaxPasswordAge             = "90"
  })
  
  tags = {
    Compliance = "ISO27001"
    Control    = "A.5.17"
  }
}

resource "aws_config_config_rule" "encrypted_volumes" {
  name = "encrypted-volumes"
  
  source {
    owner             = "AWS"
    source_identifier = "ENCRYPTED_VOLUMES"
  }
  
  tags = {
    Compliance = "ISO27001"
    Control    = "A.8.24"
  }
}

resource "aws_config_config_rule" "cloudtrail_enabled" {
  name = "cloudtrail-enabled"
  
  source {
    owner             = "AWS"
    source_identifier = "CLOUD_TRAIL_ENABLED"
  }
  
  tags = {
    Compliance = "ISO27001"
    Control    = "A.8.15"
  }
}
```

---

## PrÃ³ximos Passos

- ğŸ“˜ [IntroduÃ§Ã£o ao IaC](../iac/introduction.md)
- ğŸ“– [Melhores PrÃ¡ticas](../iac/best-practices.md)
- â˜ï¸ [Guias AWS](../clouds/aws-guides.md)
- ğŸ”· [Azure Bicep Examples](../clouds/azure-bicep-examples.md)
- ğŸŒ [GCP Best Practices](../clouds/gcp-best-practices.md)

---

## ReferÃªncias

- [ISO/IEC 27001:2022](https://www.iso.org/standard/27001)
- [AWS Security Best Practices](https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/)
- [Azure Security Documentation](https://docs.microsoft.com/azure/security/)
- [GCP Security Overview](https://cloud.google.com/security)